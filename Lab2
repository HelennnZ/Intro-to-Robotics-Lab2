int E1 = 5;     //M1 Speed Control
int E2 = 6;     //M2 Speed Control
int M1 = 4;    //M1 Direction Control
int M2 = 7;    //M1 Direction Control

int x, y, z;

int red_light_pin = 11;
int green_light_pin = 10;
int blue_light_pin = 9;

//neopixel settings
#include <Adafruit_NeoPixel.h>
#ifdef __AVR__
#include <avr/power.h>
#endif


#define LED_PIN    8

// How many NeoPixels are attached to the Arduino?
#define LED_COUNT 64

// Declare our NeoPixel strip object:
Adafruit_NeoPixel strip(LED_COUNT, LED_PIN, NEO_GRB + NEO_KHZ800);

#include <Servo.h>
Servo servo1;
Servo servo2;


void stop(void)                    //Stop
{
  digitalWrite(E1, LOW);
  digitalWrite(E2, LOW);
}
void advance(char a, char b)         //Move forward
{
  analogWrite (E1, a);     //PWM Speed Control
  digitalWrite(M1, HIGH);
  analogWrite (E2, b);
  digitalWrite(M2, HIGH);
}
void back_off (char a, char b)         //Move backward
{
  analogWrite (E1, a);
  digitalWrite(M1, LOW);
  analogWrite (E2, b);
  digitalWrite(M2, LOW);
}
void turn_L (char a, char b)            //Turn Left
{
  analogWrite (E1, a);
  digitalWrite(M1, LOW);
  analogWrite (E2, b);
  digitalWrite(M2, HIGH);
}
void turn_R (char a, char b)            //Turn Right
{
  analogWrite (E1, a);
  digitalWrite(M1, HIGH);
  analogWrite (E2, b);
  digitalWrite(M2, LOW);
}

void RGB_color(int red_light_value, int green_light_value, int blue_light_value)
{
  analogWrite(red_light_pin, red_light_value);
  analogWrite(green_light_pin, green_light_value);
  analogWrite(blue_light_pin, blue_light_value);
}


void setup(void)
{
  pinMode(red_light_pin, OUTPUT);
  pinMode(green_light_pin, OUTPUT);
  pinMode(blue_light_pin, OUTPUT);
  int i;
  for (i = 4; i <= 7; i++)
    pinMode(i, OUTPUT);
  Serial.begin(19200);      //Set Baud Rate

#if defined(__AVR_ATtiny85__) && (F_CPU == 16000000)
  clock_prescale_set(clock_div_1);
#endif
  // END of Trinket-specific code.

  strip.begin();           // INITIALIZE NeoPixel strip object (REQUIRED)
  strip.show();            // Turn OFF all pixels ASAP
  strip.setBrightness(10);
  //  pixels.begin();// Set BRIGHTNESS to about 1/5 (max = 255)
  //

}

uint32_t Wheel(byte WheelPos) {
  WheelPos = 255 - WheelPos;
  if (WheelPos < 85) {
    return strip.Color(255 - WheelPos * 3, 0, WheelPos * 3);
  }
  if (WheelPos < 170) {
    WheelPos -= 85;
    return strip.Color(0, WheelPos * 3, 255 - WheelPos * 3);
  }
  WheelPos -= 170;
  return strip.Color(WheelPos * 3, 255 - WheelPos * 3, 0);
}

// Variables will change:
int ledState = LOW;             // ledState used to set the LED

// Generally, you should use "unsigned long" for variables that hold time
// The value will quickly become too large for an int to store
unsigned long previousMillis = 0;        // will store last time LED was updated

// constants won't change:
//const long interval = 1000;           // interval at which to blink (milliseconds)
unsigned long looptimes0 = 0;
unsigned long looptimes1 = 0;
unsigned long looptimes2 = 0;
unsigned long looptimes3 = 0;
unsigned long looptimes4 = 0;

void loop() {
  unsigned long currentMillis = millis();
  if (currentMillis <= 5000) {
    //    servo1.write(0);
    //    servo2.write(0);
    if (currentMillis - previousMillis < 40) {
      RGB_color(looptimes0 , looptimes0, looptimes0);
    }
    else {
      previousMillis = currentMillis;
      looptimes0 += 1;
    }
  }
  else if ((5000 < currentMillis) && (currentMillis < 5500)) {
    servo1.write(0);
    servo2.write(0);
    RGB_color(0, 0, 0);
  }
  else if ((5500 < currentMillis) && (currentMillis < 6500)) {
    advance(100, 100);
    //    servo1.write(0);
    //    servo2.write(0);
    RGB_color(255, 255, 255);
  }
  else if ((6500 < currentMillis) && (currentMillis < 7000)) {
    advance(0, 0);
    //    servo1.write(0);
    //    servo2.write(0);
    RGB_color(0, 0, 0);
  }
  else if ((7000 < currentMillis) && (currentMillis < 8000)) {
    advance(0, 0);
    RGB_color(255, 255, 255);
  }
  //  else if ((5000 < currentMillis) && (currentMillis < 6000)) {
  //    advance(255, 255);
  //    RGB_color(255, 255, 255);
  //  }


  else if ((8000 < currentMillis ) && (currentMillis < 9000)) {
    back_off(255, 255);
    //    servo1.write(0);
    //    servo2.write(0);
    if (currentMillis - previousMillis < 50) {
      RGB_color(250 - looptimes1, 250 - looptimes1, 50 + looptimes1);
    }
    else {
      previousMillis = currentMillis;
      looptimes1 += 1;
    }

  }
  else if ((9000 < currentMillis ) && (currentMillis < 10000)) {
    advance(90, 180);
    //    servo1.write(0);
    //    servo2.write(0);
    if (currentMillis - previousMillis < 10) {
      for (int i = 0; i < strip.numPixels(); i++) {
        strip.setPixelColor(i, Wheel(((i * 256 / strip.numPixels()) + looptimes2) & 255));
      }
      strip.show();
    }
    else {
      previousMillis = currentMillis;
      looptimes2 += 1;
    }
  }
  else if ((10000 < currentMillis ) && (currentMillis < 11000)) {
    advance(180, 90);
    //    servo1.write(0);
    //    servo2.write(0);
    if (currentMillis - previousMillis < 10) {
      for (int i = 0; i < strip.numPixels(); i++) {
        strip.setPixelColor(i, Wheel(((i * 256 / strip.numPixels()) + looptimes2) & 255));
      }
      strip.show();
    }
    else {
      previousMillis = currentMillis;
      looptimes2 += 1;
    }
  }
  else if ((11000 < currentMillis ) && (currentMillis < 12000)) {
    advance(130, 180);
    //    servo1.write(0);
    //    servo2.write(0);
    if (currentMillis - previousMillis < 10) {
      for (int i = 0; i < strip.numPixels(); i++) {
        strip.setPixelColor(i, Wheel(((i * 256 / strip.numPixels()) + looptimes2) & 255));
      }
      strip.show();
    }
    else {
      previousMillis = currentMillis;
      looptimes2 += 1;
    }

  }
  else if ((12000 < currentMillis ) && (currentMillis < 13000)) {
    advance(180, 130);
    //    servo1.write(0);
    //    servo2.write(0);
    if (currentMillis - previousMillis < 10) {
      for (int i = 0; i < strip.numPixels(); i++) {
        strip.setPixelColor(i, Wheel(((i * 256 / strip.numPixels()) + looptimes2) & 255));
      }
      strip.show();
    }
    else {
      previousMillis = currentMillis;
      looptimes2 += 1;
    }

  }
  else if ((13000 < currentMillis ) && (currentMillis < 14000)) {
    advance(130, 180);
    //    servo1.write(0);
    //    servo2.write(0);
    if (currentMillis - previousMillis < 10) {
      for (int i = 0; i < strip.numPixels(); i++) {
        strip.setPixelColor(i, Wheel(((i * 256 / strip.numPixels()) + looptimes2) & 255));
      }
      strip.show();
    }
    else {
      previousMillis = currentMillis;
      looptimes2 += 1;
    }
  }
  else if ((14000 < currentMillis ) && (currentMillis < 15000)) {
    advance(255, 255);
    //    servo1.write(0);
    //    servo2.write(0);
    for (int i = 0; i < 64; i++) { // For each pixel...
      if ((i == 17) || (i == 18) || (i == 12) || (i == 20) || (i == 26) || (i == 37) || (i == 43) || (i == 45) || (i == 46) || (i == 51) ) {
        strip.setPixelColor(i, strip.Color(150, 150, 150));
      }
      else {
        strip.setPixelColor(i, strip.Color(0, 0, 0));
      }
    }
    strip.show();
  }

  else if ((15000 < currentMillis ) && (currentMillis < 17000)) {
    back_off(255, 255);
    servo1.attach(2);
    servo2.attach(3);
    if (currentMillis - previousMillis < 15) {
      servo1.write(looptimes3);
      servo2.write(looptimes3);
    }
    else {
      previousMillis = currentMillis;
      looptimes3 += 1;
    }
  }
  else if ((17000 < currentMillis ) && (currentMillis < 19000)) {
    advance(200, 200);
    if (currentMillis - previousMillis < 15) {
      servo1.write(looptimes3);
      servo2.write(looptimes3);
    }
    else {
      previousMillis = currentMillis;
      looptimes3 -= 1;
    }
  }
}

